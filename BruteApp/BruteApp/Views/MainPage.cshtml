@inherits Umbraco.Web.Mvc.UmbracoTemplatePage<ContentModels.MainPage>
@using BruteApp.Helpers
@using ContentModels = Umbraco.Web.PublishedContentModels;
@{
    Layout = "MasterLayout.cshtml";    
}

@section styles {        
    <link href="~/css/select2.css" rel="stylesheet" />
    <link href="~/css/index.css" rel="stylesheet" />
}

@section svg {
    <svg style="display: none">
        <filter id='grayscale'>
            <feColorMatrix type='matrix'
                           values='0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0'/>
        </filter>
    </svg>
}

<article>
    @*@{
        var catalog = (Catalog)Umbraco.TypedContentSingleAtXPath(string.Format("//{0}", AttributeHelper.GetTypeAlias<Catalog>()));
        var musicians = catalog.Children.SelectMany(item => item.Children).Cast<Musician>().ToList();
        var songs = musicians.SelectMany(item => item.Children.Cast<Song>()).ToList();
        var distinctSongs = songs.GroupBy(x => x.NavigationName).Select(y => y.First());
    }*@
    <div class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="filters-section">
                    <div class="col-xl-5">
                        <div class="search">
                            <select class="search-bar" type="text" placeholder="Введите название группы" autocomplete="off" autocorrect="off"></select>                            
                        </div>
                    </div>
                    @CreateCatlogMenu()
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/foals.jpg"/>
                        <div class="description">
                            <p>Foals</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/HIM.jpg"/>
                        <div class="description">
                            <p>HIM</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/Kings-of-Leon.jpg"/>
                        <div class="description">
                            <p>Kings of leon</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/TheSunshineUnderground.jpg"/>
                        <div class="description">
                            <p>The sunshine Underground</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/Kings-of-Leon.jpg"/>
                        <div class="description">
                            <p>The sunshine Underground</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/foals.jpg"/>
                        <div class="description">
                            <p>The sunshine Underground</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/foals.jpg"/>
                        <div class="description">
                            <p>The sunshine Underground</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                    <a href="javascript:void(0)" class="musician">
                        <img src="img/TheSunshineUnderground.jpg"/>
                        <div class="description">
                            <p>The sunshine Underground</p>
                            <span>перевод песен</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</article>

@section scripts {
    <script src="~/scripts/main.js"></script>
    <script>
        $(document).ready(function () {
            var search = $('.search-bar');
            search.select2({
                placeholder: 'Введите название песни или имя исполнителя',
                minimumInputLength: 1,
                maximumInputLength: 20,
                //width: 200,
                templateResult: formatRepo,
                templateSelection: formatSelectionRepo,
                escapeMarkup: function (markup) { return markup; },
                ajax: {
                    url: '/umbraco/surface/searchSurface/search',
                    dataType: 'json',
                    delay: 1000,
                    data: function (params) {
                        return {
                            q: params.term // search term
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data
                        };
                    }                    
                }                
            });

            //search= search.data('select2');

            //search.onSelect = (function (fn) {
            //    return function(data, options) {
            //        var target;

            //        if (options != null) {
            //            target = $(options.target);
            //        }

            //        if (target && target.hasClass('detail-link')) {
            //            window.location = target.attr('href');
                        
            //        } else {
            //            return fn.apply(this, arguments);
            //        }
            //    }
            //})(search.onSelect);

            search.on('select2:select', function (e) {
                window.location  = e.params.data.link;
                //console.log(data);
            });

            $('b[role="presentation"]').hide();
            $('.select2-selection__arrow').append('<i class="br-search" style="position: absolute; transform: translate(-50%, -50%); top: 50%; left: 50%;"></i>');

            function formatRepo(repo) {

                if (repo.loading) {
                    return "Поиск...";
                }

                if (!repo.id) {
                     return repo.id;
                }

                var markup = "<a style='width: 100%; height: 100%;' class='detail-link' href='" + repo.link +"'>" + repo.text + "</a>";

                return markup;
            }

            function formatSelectionRepo(repo) {

                if (repo.loading) {
                    return "Поиск...";
                }

                if (!repo.id) {
                    return repo.id;
                }

                var markup = "<p>" + repo.text + "</p>";

                return markup;
            }
        });

        //$.ajax({
        //    type: "GET",
        //    url: "/umbraco/surface/searchSurface/search",
        //    success: function (data) {
        //        console.log("data = " + JSON.stringify(data));
        //        $('.typeahead').typeahead({
        //            minLength: 1,
        //            items: 10,
        //            source: data
        //        });
        //    }
        //});

        //$('.typeahead').typeahead({
        //    minLength: 1,
        //    items: 10,
        //    source: function(query, process) {
        //        return $.get("/umbraco/surface/searchSurface/search", { query: query }, function(response){
        //            return process(response);
        //        });
        //    }
        //});


    </script>
}

@helper CreateCatlogMenu()
{
    var catalog = (Catalog) Umbraco.TypedContentSingleAtXPath(string.Format("//{0}", AttributeHelper.GetTypeAlias<Catalog>()));

    <div class="col-xl-7 no-padding">
        <div class="filter">
            <p>Выберите исполнителя по первой букве (цифре):</p>
            <ul>
                @foreach (var item in catalog.Children.OrderBy(x => x.GetPropertyValue("NavigationName")))
                {
                    if ((string) item.GetPropertyValue("navigationName") != string.Empty)
                    {
                        <li>
                            <a href="@item.Url">@item.GetPropertyValue("navigationName")</a>
                        </li>
                    }
                }
            </ul>
        </div>
    </div>
}